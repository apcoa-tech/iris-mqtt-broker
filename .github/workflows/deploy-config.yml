name: Deploy MQTT Configuration

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'config/**'
      - 'scripts/**'
      - '.github/workflows/deploy-config.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - uat
          - prd
        default: 'dev'
      restart_container:
        description: 'Restart container after deployment'
        required: true
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Configuration to ${{ inputs.environment || 'dev' }}
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load environment configuration
        id: env
        run: |
          ENV_FILE="config/env.${{ env.ENVIRONMENT }}"

          if [ ! -f "$ENV_FILE" ]; then
            echo "âŒ Environment file not found: $ENV_FILE"
            exit 1
          fi

          # Load environment variables
          set -a
          source "$ENV_FILE"
          set +a

          # Export common variables
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "storage_account=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT
          echo "bridge_username=$BRIDGE_USERNAME" >> $GITHUB_OUTPUT
          echo "local_users=$LOCAL_USERS" >> $GITHUB_OUTPUT
          echo "deploy_dual_brokers=$DEPLOY_DUAL_BROKERS" >> $GITHUB_OUTPUT

          # Export broker-specific variables
          if [ "$DEPLOY_DUAL_BROKERS" = "true" ]; then
            echo "file_share_config_1=$FILE_SHARE_CONFIG_1" >> $GITHUB_OUTPUT
            echo "file_share_config_2=$FILE_SHARE_CONFIG_2" >> $GITHUB_OUTPUT
            echo "container_group_1=$CONTAINER_GROUP_1" >> $GITHUB_OUTPUT
            echo "container_group_2=$CONTAINER_GROUP_2" >> $GITHUB_OUTPUT
            echo "external_broker_address=$EXTERNAL_BROKER_ADDRESS" >> $GITHUB_OUTPUT
          else
            echo "file_share_config=$FILE_SHARE_CONFIG" >> $GITHUB_OUTPUT
            echo "container_group=$CONTAINER_GROUP" >> $GITHUB_OUTPUT
            echo "bridge_remote_address=$BRIDGE_REMOTE_ADDRESS" >> $GITHUB_OUTPUT
          fi

          echo "âœ… Environment: ${{ env.ENVIRONMENT }}"
          echo "ðŸ“¦ Resource Group: $RESOURCE_GROUP"
          echo "ðŸ’¾ Storage Account: $STORAGE_ACCOUNT"
          echo "ðŸ”§ Dual Brokers: $DEPLOY_DUAL_BROKERS"

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup secrets from GitHub Secrets
        id: secrets
        run: |
          echo "Setting up secrets from GitHub Secrets..."

          # Bridge password
          BRIDGE_PASSWORD="${{ secrets.MQTT_BRIDGE_PASSWORD }}"
          echo "::add-mask::$BRIDGE_PASSWORD"
          echo "BRIDGE_PASSWORD=$BRIDGE_PASSWORD" >> $GITHUB_ENV

          # Setup local user passwords
          IFS=',' read -ra USERS <<< "${{ steps.env.outputs.local_users }}"
          for user in "${USERS[@]}"; do
            echo "Setting up password for user: $user"

            USER_UPPER=$(echo "$user" | tr '[:lower:]' '[:upper:]' | tr '-' '_')

            # Map users to secrets
            if [ "$user" = "deviceuser" ]; then
              PASSWORD="${{ secrets.MQTT_USER_DEVICEUSER_PASSWORD }}"
            elif [ "$user" = "adminuser" ]; then
              PASSWORD="${{ secrets.MQTT_USER_ADMINUSER_PASSWORD }}"
            elif [ "$user" = "external_integration_user" ]; then
              PASSWORD="${{ secrets.MQTT_BRIDGE_PASSWORD }}"
            fi

            if [ -n "$PASSWORD" ]; then
              echo "::add-mask::$PASSWORD"
              echo "PASSWORD_${USER_UPPER}=$PASSWORD" >> $GITHUB_ENV
            else
              echo "âš ï¸  Warning: GitHub secret not found for user $user"
            fi
          done

          echo "âœ… Secrets loaded from GitHub"

      - name: Get storage account key
        id: storage
        run: |
          STORAGE_KEY=$(az storage account keys list \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --account-name ${{ steps.env.outputs.storage_account }} \
            --query '[0].value' -o tsv)

          echo "::add-mask::$STORAGE_KEY"
          echo "storage_key=$STORAGE_KEY" >> $GITHUB_OUTPUT

      # ============================================================
      # CERTIFICATE UPLOAD (First-time setup or cert renewal)
      # ============================================================
      - name: Check if certificates exist
        id: cert_check
        env:
          AZURE_STORAGE_ACCOUNT: ${{ steps.env.outputs.storage_account }}
          AZURE_STORAGE_KEY: ${{ steps.storage.outputs.storage_key }}
        run: |
          # Check if certificates already exist
          CERT_EXISTS=false

          if [ "${{ steps.env.outputs.deploy_dual_brokers }}" = "true" ]; then
            SHARE_NAME="${{ steps.env.outputs.file_share_config_1 }}"
            # For dual broker, use mqtt-certs share
            SHARE_NAME="iris-${{ env.ENVIRONMENT }}-mqtt-certs"
          else
            SHARE_NAME="${{ steps.env.outputs.file_share_config }}"
            SHARE_NAME="iris-${{ env.ENVIRONMENT }}-mqtt-certs"
          fi

          # Check if server.crt exists
          if az storage file exists \
            --share-name "$SHARE_NAME" \
            --path server.crt \
            --query exists -o tsv 2>/dev/null | grep -q true; then
            CERT_EXISTS=true
          fi

          echo "cert_exists=$CERT_EXISTS" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Certificates exist: $CERT_EXISTS"

      - name: Generate self-signed certificates (Dev/UAT - if missing)
        if: steps.cert_check.outputs.cert_exists == 'false' && env.ENVIRONMENT != 'prd'
        run: |
          echo "ðŸ” Generating self-signed certificates for ${{ env.ENVIRONMENT }} environment..."
          mkdir -p /tmp/certs

          # Generate CA certificate
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /tmp/certs/ca.key \
            -out /tmp/certs/ca.crt \
            -subj "/CN=IRIS ${{ env.ENVIRONMENT }} CA/O=APCOA/C=DE"

          # Generate server certificate
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /tmp/certs/server.key \
            -out /tmp/certs/server.crt \
            -subj "/CN=*.westeurope.azurecontainer.io/O=APCOA/C=DE"

          # Generate production CA (self-signed for dev/uat testing)
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /tmp/certs/production_ca.key \
            -out /tmp/certs/production_ca.crt \
            -subj "/CN=Production CA Simulator/O=APCOA/C=DE"

          echo "âœ… Self-signed certificates generated"

      - name: Upload certificates (if generated)
        if: steps.cert_check.outputs.cert_exists == 'false'
        env:
          AZURE_STORAGE_ACCOUNT: ${{ steps.env.outputs.storage_account }}
          AZURE_STORAGE_KEY: ${{ steps.storage.outputs.storage_key }}
        run: |
          if [ "${{ env.ENVIRONMENT }}" = "prd" ]; then
            echo "âŒ Production environment requires proper CA-signed certificates"
            echo "Please upload certificates manually to iris-prd-mqtt-certs file share"
            exit 1
          fi

          CERTS_SHARE="iris-${{ env.ENVIRONMENT }}-mqtt-certs"
          BRIDGE_CERTS_SHARE="iris-${{ env.ENVIRONMENT }}-mqtt-bridge-certs"

          echo "ðŸ“¤ Uploading TLS certificates to $CERTS_SHARE..."

          # Upload server certificates
          az storage file upload --share-name "$CERTS_SHARE" \
            --source /tmp/certs/server.crt --path server.crt --overwrite

          az storage file upload --share-name "$CERTS_SHARE" \
            --source /tmp/certs/server.key --path server.key --overwrite

          az storage file upload --share-name "$CERTS_SHARE" \
            --source /tmp/certs/ca.crt --path ca.crt --overwrite

          echo "âœ… TLS certificates uploaded to $CERTS_SHARE"

          # Upload bridge CA certificate
          echo "ðŸ“¤ Uploading bridge CA to $BRIDGE_CERTS_SHARE..."

          az storage file upload --share-name "$BRIDGE_CERTS_SHARE" \
            --source /tmp/certs/production_ca.crt --path production_ca.crt --overwrite

          echo "âœ… Bridge CA uploaded to $BRIDGE_CERTS_SHARE"

      # ============================================================
      # DUAL BROKER DEPLOYMENT (DEV)
      # ============================================================
      - name: Generate mosquitto.conf for mqtt-1 (Our Broker)
        if: steps.env.outputs.deploy_dual_brokers == 'true'
        env:
          BRIDGE_USERNAME: ${{ steps.env.outputs.bridge_username }}
          EXTERNAL_BROKER_ADDRESS: ${{ steps.env.outputs.external_broker_address }}
        run: |
          echo "Generating mosquitto.conf for mqtt-1 (our production simulator)..."

          ./scripts/generate-config.sh \
            config/mosquitto-mqtt-1.conf.template \
            /tmp/mosquitto-1.conf

          echo "âœ… mosquitto.conf for mqtt-1 generated"

      - name: Generate mosquitto.conf for mqtt-2 (External Company Simulator)
        if: steps.env.outputs.deploy_dual_brokers == 'true'
        run: |
          echo "Generating mosquitto.conf for mqtt-2 (external company simulator)..."

          # mqtt-2 has no bridge config, just standalone broker
          ./scripts/generate-config.sh \
            config/mosquitto-mqtt-2.conf.template \
            /tmp/mosquitto-2.conf

          echo "âœ… mosquitto.conf for mqtt-2 generated"

      - name: Generate password.txt (shared)
        if: steps.env.outputs.deploy_dual_brokers == 'true'
        run: |
          echo "Generating password file (shared by both brokers)..."

          ./scripts/generate-password-file.sh \
            /tmp/password.txt \
            "${{ steps.env.outputs.local_users }}"

          echo "âœ… password.txt generated"

      - name: Upload mqtt-1 configuration to Azure File Share
        if: steps.env.outputs.deploy_dual_brokers == 'true'
        env:
          AZURE_STORAGE_ACCOUNT: ${{ steps.env.outputs.storage_account }}
          AZURE_STORAGE_KEY: ${{ steps.storage.outputs.storage_key }}
        run: |
          echo "Uploading files to mqtt-1 file share: ${{ steps.env.outputs.file_share_config_1 }}"

          # Upload mosquitto.conf for mqtt-1
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config_1 }} \
            --source /tmp/mosquitto-1.conf \
            --path mosquitto.conf \
            --overwrite

          # Upload shared password.txt
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config_1 }} \
            --source /tmp/password.txt \
            --path password.txt \
            --overwrite

          echo "âœ… mqtt-1 configuration uploaded"

      - name: Upload mqtt-2 configuration to Azure File Share
        if: steps.env.outputs.deploy_dual_brokers == 'true'
        env:
          AZURE_STORAGE_ACCOUNT: ${{ steps.env.outputs.storage_account }}
          AZURE_STORAGE_KEY: ${{ steps.storage.outputs.storage_key }}
        run: |
          echo "Uploading files to mqtt-2 file share: ${{ steps.env.outputs.file_share_config_2 }}"

          # Upload mosquitto.conf for mqtt-2
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config_2 }} \
            --source /tmp/mosquitto-2.conf \
            --path mosquitto.conf \
            --overwrite

          # Upload shared password.txt
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config_2 }} \
            --source /tmp/password.txt \
            --path password.txt \
            --overwrite

          echo "âœ… mqtt-2 configuration uploaded"

      - name: Restart mqtt-1 container
        if: steps.env.outputs.deploy_dual_brokers == 'true' && (inputs.restart_container != false || github.event_name == 'push')
        continue-on-error: true
        run: |
          echo "Restarting mqtt-1 container: ${{ steps.env.outputs.container_group_1 }}"

          az container restart \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group_1 }}

          echo "âœ… mqtt-1 container restarted"

      - name: Restart mqtt-2 container
        if: steps.env.outputs.deploy_dual_brokers == 'true' && (inputs.restart_container != false || github.event_name == 'push')
        continue-on-error: true
        run: |
          echo "Restarting mqtt-2 container: ${{ steps.env.outputs.container_group_2 }}"

          az container restart \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group_2 }}

          echo "âœ… mqtt-2 container restarted"

      # ============================================================
      # SINGLE BROKER DEPLOYMENT (PRD)
      # ============================================================
      - name: Generate mosquitto.conf for single broker
        if: steps.env.outputs.deploy_dual_brokers != 'true'
        env:
          BRIDGE_USERNAME: ${{ steps.env.outputs.bridge_username }}
          BRIDGE_REMOTE_ADDRESS: ${{ steps.env.outputs.bridge_remote_address }}
        run: |
          echo "Generating mosquitto.conf for single broker..."

          ./scripts/generate-config.sh \
            config/mosquitto-prd.conf.template \
            /tmp/mosquitto.conf

          echo "âœ… mosquitto.conf generated"

      - name: Generate password.txt for single broker
        if: steps.env.outputs.deploy_dual_brokers != 'true'
        run: |
          echo "Generating password file..."

          ./scripts/generate-password-file.sh \
            /tmp/password.txt \
            "${{ steps.env.outputs.local_users }}"

          echo "âœ… password.txt generated"

      - name: Upload single broker configuration to Azure File Share
        if: steps.env.outputs.deploy_dual_brokers != 'true'
        env:
          AZURE_STORAGE_ACCOUNT: ${{ steps.env.outputs.storage_account }}
          AZURE_STORAGE_KEY: ${{ steps.storage.outputs.storage_key }}
        run: |
          echo "Uploading files to file share: ${{ steps.env.outputs.file_share_config }}"

          # Upload mosquitto.conf
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config }} \
            --source /tmp/mosquitto.conf \
            --path mosquitto.conf \
            --overwrite

          # Upload password.txt
          az storage file upload \
            --share-name ${{ steps.env.outputs.file_share_config }} \
            --source /tmp/password.txt \
            --path password.txt \
            --overwrite

          echo "âœ… Configuration uploaded"

      - name: Restart single broker container
        if: steps.env.outputs.deploy_dual_brokers != 'true' && (inputs.restart_container != false || github.event_name == 'push')
        continue-on-error: true
        run: |
          echo "Restarting container: ${{ steps.env.outputs.container_group }}"

          az container restart \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group }}

          echo "âœ… Container restarted"

      # ============================================================
      # STATUS CHECK
      # ============================================================
      - name: Check container status (dual brokers)
        if: steps.env.outputs.deploy_dual_brokers == 'true' && (inputs.restart_container != false || github.event_name == 'push')
        run: |
          sleep 15

          echo "Checking mqtt-1 status..."
          STATUS_1=$(az container show \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group_1 }} \
            --query instanceView.state -o tsv)

          echo "Checking mqtt-2 status..."
          STATUS_2=$(az container show \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group_2 }} \
            --query instanceView.state -o tsv)

          echo "mqtt-1 status: $STATUS_1"
          echo "mqtt-2 status: $STATUS_2"

          if [ "$STATUS_1" = "Running" ] && [ "$STATUS_2" = "Running" ]; then
            echo "âœ… Both containers are running"
          else
            echo "âš ï¸  One or more containers not running"
          fi

      - name: Check container status (single broker)
        if: steps.env.outputs.deploy_dual_brokers != 'true' && (inputs.restart_container != false || github.event_name == 'push')
        run: |
          sleep 10

          STATUS=$(az container show \
            --resource-group ${{ steps.env.outputs.resource_group }} \
            --name ${{ steps.env.outputs.container_group }} \
            --query instanceView.state -o tsv)

          echo "Container status: $STATUS"

          if [ "$STATUS" = "Running" ]; then
            echo "âœ… Container is running"
          else
            echo "âš ï¸  Container is not running: $STATUS"
          fi

      - name: Summary
        run: |
          echo "## ðŸ“ MQTT Configuration Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Account:** ${{ steps.env.outputs.storage_account }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Certificate status
          if [ "${{ steps.cert_check.outputs.cert_exists }}" = "false" ]; then
            echo "### ðŸ” Certificates" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Generated and uploaded self-signed certificates" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… server.crt, server.key, ca.crt" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… production_ca.crt (bridge)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ” Certificates" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸  Existing certificates retained (not replaced)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.env.outputs.deploy_dual_brokers }}" = "true" ]; then
            echo "**Deployment Type:** Dual Broker (Simulation)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### MQTT Broker 1 (Our Broker Simulator)" >> $GITHUB_STEP_SUMMARY
            echo "- File Share: ${{ steps.env.outputs.file_share_config_1 }}" >> $GITHUB_STEP_SUMMARY
            echo "- Container: ${{ steps.env.outputs.container_group_1 }}" >> $GITHUB_STEP_SUMMARY
            echo "- Config: âœ… mosquitto.conf, âœ… password.txt" >> $GITHUB_STEP_SUMMARY
            echo "- Bridge: â†’ mqtt-2 (simulates external company)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### MQTT Broker 2 (External Company Simulator)" >> $GITHUB_STEP_SUMMARY
            echo "- File Share: ${{ steps.env.outputs.file_share_config_2 }}" >> $GITHUB_STEP_SUMMARY
            echo "- Container: ${{ steps.env.outputs.container_group_2 }}" >> $GITHUB_STEP_SUMMARY
            echo "- Config: âœ… mosquitto.conf, âœ… password.txt" >> $GITHUB_STEP_SUMMARY
            echo "- Mode: Standalone (accepts bridge from mqtt-1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Deployment Type:** Single Broker (Production)" >> $GITHUB_STEP_SUMMARY
            echo "- File Share: ${{ steps.env.outputs.file_share_config }}" >> $GITHUB_STEP_SUMMARY
            echo "- Container: ${{ steps.env.outputs.container_group }}" >> $GITHUB_STEP_SUMMARY
            echo "- Config: âœ… mosquitto.conf, âœ… password.txt" >> $GITHUB_STEP_SUMMARY
            echo "- Bridge: â†’ External company broker" >> $GITHUB_STEP_SUMMARY
          fi
